<!doctype html><html lang=en class=no-js> <head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=author content=Dewey.Amer><link href=../../../01/31/%E6%BC%AB%E8%B0%88gptrag/ rel=prev><link href=../../../04/16/rag-evaluate/ rel=next><link rel=icon href=../../../../../assets/images/favicon.png><meta name=generator content="mkdocs-1.6.1, mkdocs-material-9.6.21"><title>Python Async - What's wrong with you?</title><link rel=stylesheet href=../../../../../assets/stylesheets/main.2a3383ac.min.css><link rel=stylesheet href=../../../../../assets/stylesheets/palette.06af60db.min.css><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback"><style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style><script>__md_scope=new URL("../../../../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script></head> <body dir=ltr data-md-color-scheme=slate data-md-color-primary=black data-md-color-accent=indigo> <input class=md-toggle data-md-toggle=drawer type=checkbox id=__drawer autocomplete=off> <input class=md-toggle data-md-toggle=search type=checkbox id=__search autocomplete=off> <label class=md-overlay for=__drawer></label> <div data-md-component=skip> <a href=#python-async class=md-skip> Skip to content </a> </div> <div data-md-component=announce> </div> <header class="md-header md-header--shadow md-header--lifted" data-md-component=header> <nav class="md-header__inner md-grid" aria-label=Header> <a href=../../../../.. title="What's wrong with you?" class="md-header__button md-logo" aria-label="What's wrong with you?" data-md-component=logo> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg> </a> <label class="md-header__button md-icon" for=__drawer> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg> </label> <div class=md-header__title data-md-component=header-title> <div class=md-header__ellipsis> <div class=md-header__topic> <span class=md-ellipsis> What's wrong with you? </span> </div> <div class=md-header__topic data-md-component=header-topic> <span class=md-ellipsis> Python Async </span> </div> </div> </div> <form class=md-header__option data-md-component=palette> <input class=md-option data-md-color-media=(prefers-color-scheme) data-md-color-scheme=slate data-md-color-primary=black data-md-color-accent=indigo aria-label="Switch to light mode" type=radio name=__palette id=__palette_0> <label class="md-header__button md-icon" title="Switch to light mode" for=__palette_1 hidden> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7a5 5 0 0 0-5 5 5 5 0 0 0 5 5h4v-1.9H7c-1.71 0-3.1-1.39-3.1-3.1M8 13h8v-2H8zm9-6h-4v1.9h4c1.71 0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4a5 5 0 0 0 5-5 5 5 0 0 0-5-5"/></svg> </label> <input class=md-option data-md-color-media="(prefers-color-scheme: light)" data-md-color-scheme=default data-md-color-primary=indigo data-md-color-accent=indigo aria-label="Switch to dark mode" type=radio name=__palette id=__palette_1> <label class="md-header__button md-icon" title="Switch to dark mode" for=__palette_2 hidden> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M17 7H7a5 5 0 0 0-5 5 5 5 0 0 0 5 5h10a5 5 0 0 0 5-5 5 5 0 0 0-5-5m0 8a3 3 0 0 1-3-3 3 3 0 0 1 3-3 3 3 0 0 1 3 3 3 3 0 0 1-3 3"/></svg> </label> <input class=md-option data-md-color-media="(prefers-color-scheme: dark)" data-md-color-scheme=slate data-md-color-primary=black data-md-color-accent=indigo aria-label="Switch to system preference" type=radio name=__palette id=__palette_2> <label class="md-header__button md-icon" title="Switch to system preference" for=__palette_0 hidden> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M17 7H7a5 5 0 0 0-5 5 5 5 0 0 0 5 5h10a5 5 0 0 0 5-5 5 5 0 0 0-5-5M7 15a3 3 0 0 1-3-3 3 3 0 0 1 3-3 3 3 0 0 1 3 3 3 3 0 0 1-3 3"/></svg> </label> </form> <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script> <label class="md-header__button md-icon" for=__search> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg> </label> <div class=md-search data-md-component=search role=dialog> <label class=md-search__overlay for=__search></label> <div class=md-search__inner role=search> <form class=md-search__form name=search> <input type=text class=md-search__input name=query aria-label=Search placeholder=Search autocapitalize=off autocorrect=off autocomplete=off spellcheck=false data-md-component=search-query required> <label class="md-search__icon md-icon" for=__search> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg> </label> <nav class=md-search__options aria-label=Search> <a href=javascript:void(0) class="md-search__icon md-icon" title=Share aria-label=Share data-clipboard data-clipboard-text data-md-component=search-share tabindex=-1> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M18 16.08c-.76 0-1.44.3-1.96.77L8.91 12.7c.05-.23.09-.46.09-.7s-.04-.47-.09-.7l7.05-4.11c.54.5 1.25.81 2.04.81a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3c0 .24.04.47.09.7L8.04 9.81C7.5 9.31 6.79 9 6 9a3 3 0 0 0-3 3 3 3 0 0 0 3 3c.79 0 1.5-.31 2.04-.81l7.12 4.15c-.05.21-.08.43-.08.66 0 1.61 1.31 2.91 2.92 2.91s2.92-1.3 2.92-2.91A2.92 2.92 0 0 0 18 16.08"/></svg> </a> <button type=reset class="md-search__icon md-icon" title=Clear aria-label=Clear tabindex=-1> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg> </button> </nav> <div class=md-search__suggest data-md-component=search-suggest></div> </form> <div class=md-search__output> <div class=md-search__scrollwrap tabindex=0 data-md-scrollfix> <div class=md-search-result data-md-component=search-result> <div class=md-search-result__meta> Initializing search </div> <ol class=md-search-result__list role=presentation></ol> </div> </div> </div> </div> </div> </nav> <nav class=md-tabs aria-label=Tabs data-md-component=tabs> <div class=md-grid> <ul class=md-tabs__list> <li class=md-tabs__item> <a href=../../../../.. class=md-tabs__link> Home </a> </li> <li class="md-tabs__item md-tabs__item--active"> <a href=../../../../ class=md-tabs__link> Blog </a> </li> <li class=md-tabs__item> <a href=../../../../../photography/ class=md-tabs__link> Photography </a> </li> </ul> </div> </nav> </header> <div class=md-container data-md-component=container> <main class=md-main data-md-component=main> <div class="md-main__inner md-grid"> <div class="md-sidebar md-sidebar--primary" data-md-component=sidebar data-md-type=navigation hidden> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav class="md-nav md-nav--primary md-nav--lifted" aria-label=Navigation data-md-level=0> <label class=md-nav__title for=__drawer> <a href=../../../../.. title="What's wrong with you?" class="md-nav__button md-logo" aria-label="What's wrong with you?" data-md-component=logo> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg> </a> What's wrong with you? </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../../.. class=md-nav__link> <span class=md-ellipsis> Home </span> </a> </li> <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_2 checked> <div class="md-nav__link md-nav__container"> <a href=../../../../ class="md-nav__link "> <span class=md-ellipsis> Blog </span> </a> <label class="md-nav__link " for=__nav_2 id=__nav_2_label tabindex> <span class="md-nav__icon md-icon"></span> </label> </div> <nav class=md-nav data-md-level=1 aria-labelledby=__nav_2_label aria-expanded=true> <label class=md-nav__title for=__nav_2> <span class="md-nav__icon md-icon"></span> Blog </label> <ul class=md-nav__list data-md-scrollfix> <li class="md-nav__item md-nav__item--section md-nav__item--nested"> <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type=checkbox id=__nav_2_2> <label class=md-nav__link for=__nav_2_2 id=__nav_2_2_label tabindex> <span class=md-ellipsis> Archive </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_2_2_label aria-expanded=false> <label class=md-nav__title for=__nav_2_2> <span class="md-nav__icon md-icon"></span> Archive </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../../archive/2025/ class=md-nav__link> <span class=md-ellipsis> 2025 </span> </a> </li> <li class=md-nav__item> <a href=../../../../archive/2024/ class=md-nav__link> <span class=md-ellipsis> 2024 </span> </a> </li> <li class=md-nav__item> <a href=../../../../archive/2023/ class=md-nav__link> <span class=md-ellipsis> 2023 </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--section md-nav__item--nested"> <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type=checkbox id=__nav_2_3> <label class=md-nav__link for=__nav_2_3 id=__nav_2_3_label tabindex> <span class=md-ellipsis> Categories </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_2_3_label aria-expanded=false> <label class=md-nav__title for=__nav_2_3> <span class="md-nav__icon md-icon"></span> Categories </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../../category/conversations/ class=md-nav__link> <span class=md-ellipsis> Conversations </span> </a> </li> <li class=md-nav__item> <a href=../../../../category/embedding/ class=md-nav__link> <span class=md-ellipsis> Embedding </span> </a> </li> <li class=md-nav__item> <a href=../../../../category/python/ class=md-nav__link> <span class=md-ellipsis> Python </span> </a> </li> <li class=md-nav__item> <a href=../../../../category/rag/ class=md-nav__link> <span class=md-ellipsis> RAG </span> </a> </li> <li class=md-nav__item> <a href=../../../../category/sociology/ class=md-nav__link> <span class=md-ellipsis> Sociology </span> </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=../../../../../photography/ class=md-nav__link> <span class=md-ellipsis> Photography </span> </a> </li> </ul> </nav> </div> </div> </div> <div class="md-sidebar md-sidebar--secondary" data-md-component=sidebar data-md-type=toc> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav class="md-nav md-nav--secondary" aria-label="Table of contents"> <label class=md-nav__title for=__toc> <span class="md-nav__icon md-icon"></span> Table of contents </label> <ul class=md-nav__list data-md-component=toc data-md-scrollfix> <li class=md-nav__item> <a href=#parallelism-vs-threading class=md-nav__link> <span class=md-ellipsis> Parallelism V.S. Threading </span> </a> <nav class=md-nav aria-label="Parallelism V.S. Threading"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#processpoolexecutor class=md-nav__link> <span class=md-ellipsis> ProcessPoolExecutor </span> </a> </li> <li class=md-nav__item> <a href=#threadpoolexecutor class=md-nav__link> <span class=md-ellipsis> ThreadPoolExecutor </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#async-io class=md-nav__link> <span class=md-ellipsis> Async IO </span> </a> <nav class=md-nav aria-label="Async IO"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#event-loop class=md-nav__link> <span class=md-ellipsis> Event loop </span> </a> </li> <li class=md-nav__item> <a href=#io class=md-nav__link> <span class=md-ellipsis> IO密集同步异步图解 </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#summary class=md-nav__link> <span class=md-ellipsis> Summary </span> </a> </li> <li class=md-nav__item> <a href=#reference class=md-nav__link> <span class=md-ellipsis> Reference </span> </a> </li> </ul> </nav> </div> </div> </div> <div class="md-content md-content--post" data-md-component=content> <div class="md-sidebar md-sidebar--post" data-md-component=sidebar data-md-type=navigation> <div class=md-sidebar__scrollwrap> <div class="md-sidebar__inner md-post"> <nav class="md-nav md-nav--primary"> <div class=md-post__back> <div class="md-nav__title md-nav__container"> <a href=../../../../ class=md-nav__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg> <span class=md-ellipsis> Back to index </span> </a> </div> </div> <div class="md-post__authors md-typeset"> <div class="md-profile md-post__profile"> <span class="md-author md-author--long"> <img src=https://github.com/deweyamer.png alt=Dewey> </span> <span class=md-profile__description> <strong> Dewey </strong> <br> Creator </span> </div> </div> <ul class="md-post__meta md-nav__list"> <li class="md-nav__item md-nav__item--section"> <div class=md-post__title> <span class=md-ellipsis> Metadata </span> </div> <nav class=md-nav> <ul class=md-nav__list> <li class=md-nav__item> <div class=md-nav__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M19 19H5V8h14m-3-7v2H8V1H6v2H5c-1.11 0-2 .89-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V5a2 2 0 0 0-2-2h-1V1m-1 11h-5v5h5z"/></svg> <time datetime="2024-03-09 00:00:00+00:00" class=md-ellipsis>March 9, 2024</time> </div> </li> <li class=md-nav__item> <div class=md-nav__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M9 3v15h3V3zm3 2 4 13 3-1-4-13zM5 5v13h3V5zM3 19v2h18v-2z"/></svg> <span class=md-ellipsis> in <a href=../../../../category/python/ >Python</a></span> </div> </li> <li class=md-nav__item> <div class=md-nav__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M12 20a8 8 0 0 0 8-8 8 8 0 0 0-8-8 8 8 0 0 0-8 8 8 8 0 0 0 8 8m0-18a10 10 0 0 1 10 10 10 10 0 0 1-10 10C6.47 22 2 17.5 2 12A10 10 0 0 1 12 2m.5 5v5.25l4.5 2.67-.75 1.23L11 13V7z"/></svg> <span class=md-ellipsis> 15 min read </span> </div> </li> </ul> </nav> </li> </ul> </nav> </div> </div> </div> <article class="md-content__inner md-typeset"> <h1 id=python-async>Python Async<a class=headerlink href=#python-async title="Permanent link">&para;</a></h1> <h2 id=parallelism-vs-threading>Parallelism V.S. Threading<a class=headerlink href=#parallelism-vs-threading title="Permanent link">&para;</a></h2> <p>进程（Process）和线程（Thread）是计算机科学中重要的概念，它们用于管理计算机执行任务的方式。它们之间的主要区别在于它们管理资源的方式和执行任务的方式。</p> <ol> <li><strong>进程（Process）</strong><ul> <li>进程是操作系统分配资源的基本单位。它包含了程序代码、数据以及程序执行时所需的各种系统资源（如内存空间、文件句柄等）。</li> <li>每个进程都有自己独立的内存空间，一个进程不能直接访问另一个进程的内存。</li> <li>进程之间的切换开销相对较高，因为切换进程需要保存和恢复整个进程的状态。</li> <li>进程之间通常是相互独立的，它们通过进程间通信（IPC）来进行数据交换。</li> </ul> </li> <li><strong>线程（Thread）</strong><ul> <li>线程是进程内部的执行单元。一个进程可以包含多个线程，它们共享进程的资源（如内存空间、文件句柄等）。</li> <li>线程之间共享相同的内存空间，因此可以直接访问同一进程内的数据。</li> <li>线程之间切换的开销较低，因为线程共享同一进程的地址空间，切换时只需保存和恢复少量的线程状态。</li> <li>由于线程共享同一进程的资源，线程之间的同步和通信更加容易和高效。</li> </ul> </li> </ol> <!-- more --> <p>主要区别总结如下：</p> <ul> <li>进程是资源分配的基本单位，而线程是操作系统调度的基本单位。</li> <li>进程之间相互独立，而线程共享同一进程的资源。</li> <li>进程切换开销大，线程切换开销小。</li> <li>进程通信需要较高的开销，而线程通信相对简单。</li> </ul> <p>但是在CPython解释器中由于GIL的存在，Python无法实现并行的多线程，同一时刻只有一个线程执行 Python 字节码，即并发的多线程。</p> <p>我们以<code>Concurrent.future</code>中的<code>ProcessPoolExecutor</code>和<code>ThreadPoolExecutor</code>来观察进程池和线程池是如何管理和执行进程和线程的。</p> <h3 id=processpoolexecutor>ProcessPoolExecutor<a class=headerlink href=#processpoolexecutor title="Permanent link">&para;</a></h3> <p>对于<code>ProcessPoolExecutor</code>来说，它能够实现真正的并行处理，因为它使用的是进程而不是线程来执行任务。在Python中，每个进程都有自己独立的Python解释器和内存空间，因此不受全局解释锁（GIL）的限制，多个进程可以同时执行Python字节码，从而实现真正的并行处理。</p> <p><strong>进程池的创建</strong>：</p> <div class="language-python highlight"><pre><span></span><code><span id=__span-0-1><a id=__codelineno-0-1 name=__codelineno-0-1 href=#__codelineno-0-1></a><span class=k>class</span><span class=w> </span><span class=nc>ProcessPoolExecutor</span><span class=p>(</span><span class=n>_base</span><span class=o>.</span><span class=n>Executor</span><span class=p>):</span>
</span><span id=__span-0-2><a id=__codelineno-0-2 name=__codelineno-0-2 href=#__codelineno-0-2></a>    <span class=k>def</span><span class=w> </span><span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>max_workers</span><span class=o>=</span><span class=kc>None</span><span class=p>):</span>
</span><span id=__span-0-3><a id=__codelineno-0-3 name=__codelineno-0-3 href=#__codelineno-0-3></a>        <span class=o>...</span>
</span><span id=__span-0-4><a id=__codelineno-0-4 name=__codelineno-0-4 href=#__codelineno-0-4></a>        <span class=k>if</span> <span class=n>max_workers</span> <span class=ow>is</span> <span class=kc>None</span><span class=p>:</span>
</span><span id=__span-0-5><a id=__codelineno-0-5 name=__codelineno-0-5 href=#__codelineno-0-5></a>            <span class=bp>self</span><span class=o>.</span><span class=n>_max_workers</span> <span class=o>=</span> <span class=n>os</span><span class=o>.</span><span class=n>cpu_count</span><span class=p>()</span> <span class=ow>or</span> <span class=mi>1</span>  <span class=c1># 默认使用CPU核心数</span>
</span><span id=__span-0-6><a id=__codelineno-0-6 name=__codelineno-0-6 href=#__codelineno-0-6></a>        <span class=k>else</span><span class=p>:</span>
</span><span id=__span-0-7><a id=__codelineno-0-7 name=__codelineno-0-7 href=#__codelineno-0-7></a>            <span class=k>if</span> <span class=n>max_workers</span> <span class=o>&lt;=</span> <span class=mi>0</span><span class=p>:</span>
</span><span id=__span-0-8><a id=__codelineno-0-8 name=__codelineno-0-8 href=#__codelineno-0-8></a>                <span class=k>raise</span> <span class=ne>ValueError</span><span class=p>(</span><span class=s2>&quot;max_workers must be greater than 0&quot;</span><span class=p>)</span>
</span><span id=__span-0-9><a id=__codelineno-0-9 name=__codelineno-0-9 href=#__codelineno-0-9></a>            <span class=bp>self</span><span class=o>.</span><span class=n>_max_workers</span> <span class=o>=</span> <span class=n>max_workers</span>
</span><span id=__span-0-10><a id=__codelineno-0-10 name=__codelineno-0-10 href=#__codelineno-0-10></a>        <span class=o>...</span>
</span><span id=__span-0-11><a id=__codelineno-0-11 name=__codelineno-0-11 href=#__codelineno-0-11></a>        <span class=bp>self</span><span class=o>.</span><span class=n>_processes</span> <span class=o>=</span> <span class=nb>set</span><span class=p>()</span>  <span class=c1># 存放进程的集合</span>
</span></code></pre></div> <p>在初始化时，<code>ProcessPoolExecutor</code>会创建一定数量的进程，并将它们存放在进程池中。默认情况下，进程池会使用系统中的CPU核心数作为最大工作进程数。</p> <p><strong>任务分配和执行</strong>：</p> <div class="language-python highlight"><pre><span></span><code><span id=__span-1-1><a id=__codelineno-1-1 name=__codelineno-1-1 href=#__codelineno-1-1></a><span class=k>class</span><span class=w> </span><span class=nc>ProcessPoolExecutor</span><span class=p>(</span><span class=n>_base</span><span class=o>.</span><span class=n>Executor</span><span class=p>):</span>
</span><span id=__span-1-2><a id=__codelineno-1-2 name=__codelineno-1-2 href=#__codelineno-1-2></a>    <span class=o>...</span>
</span><span id=__span-1-3><a id=__codelineno-1-3 name=__codelineno-1-3 href=#__codelineno-1-3></a>    <span class=k>def</span><span class=w> </span><span class=nf>submit</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>fn</span><span class=p>,</span> <span class=o>*</span><span class=n>args</span><span class=p>,</span> <span class=o>**</span><span class=n>kwargs</span><span class=p>):</span>
</span><span id=__span-1-4><a id=__codelineno-1-4 name=__codelineno-1-4 href=#__codelineno-1-4></a>        <span class=o>...</span>
</span><span id=__span-1-5><a id=__codelineno-1-5 name=__codelineno-1-5 href=#__codelineno-1-5></a>        <span class=k>with</span> <span class=bp>self</span><span class=o>.</span><span class=n>_shutdown_lock</span><span class=p>:</span>
</span><span id=__span-1-6><a id=__codelineno-1-6 name=__codelineno-1-6 href=#__codelineno-1-6></a>            <span class=k>if</span> <span class=bp>self</span><span class=o>.</span><span class=n>_shutdown</span><span class=p>:</span>
</span><span id=__span-1-7><a id=__codelineno-1-7 name=__codelineno-1-7 href=#__codelineno-1-7></a>                <span class=k>raise</span> <span class=ne>RuntimeError</span><span class=p>(</span><span class=s1>&#39;cannot schedule new futures after shutdown&#39;</span><span class=p>)</span>
</span><span id=__span-1-8><a id=__codelineno-1-8 name=__codelineno-1-8 href=#__codelineno-1-8></a>            <span class=n>f</span> <span class=o>=</span> <span class=n>_base</span><span class=o>.</span><span class=n>Future</span><span class=p>()</span>
</span><span id=__span-1-9><a id=__codelineno-1-9 name=__codelineno-1-9 href=#__codelineno-1-9></a>            <span class=bp>self</span><span class=o>.</span><span class=n>_pending_work_items</span><span class=o>.</span><span class=n>put</span><span class=p>((</span><span class=n>f</span><span class=p>,</span> <span class=n>fn</span><span class=p>,</span> <span class=n>args</span><span class=p>,</span> <span class=n>kwargs</span><span class=p>))</span>  <span class=c1># 将任务放入待处理队列</span>
</span><span id=__span-1-10><a id=__codelineno-1-10 name=__codelineno-1-10 href=#__codelineno-1-10></a>            <span class=bp>self</span><span class=o>.</span><span class=n>_adjust_process_count</span><span class=p>()</span>  <span class=c1># 调整进程数量</span>
</span><span id=__span-1-11><a id=__codelineno-1-11 name=__codelineno-1-11 href=#__codelineno-1-11></a>        <span class=k>return</span> <span class=n>f</span>
</span></code></pre></div> <p>任务提交到<code>ProcessPoolExecutor</code>时，会被放入待处理队列<code>_pending_work_items</code>中。然后，<code>_adjust_process_count</code>方法会根据需要动态地调整进程数量，确保有足够的进程来处理任务。</p> <p><strong>进程池的管理</strong>：</p> <div class="language-python highlight"><pre><span></span><code><span id=__span-2-1><a id=__codelineno-2-1 name=__codelineno-2-1 href=#__codelineno-2-1></a><span class=k>class</span><span class=w> </span><span class=nc>ProcessPoolExecutor</span><span class=p>(</span><span class=n>_base</span><span class=o>.</span><span class=n>Executor</span><span class=p>):</span>
</span><span id=__span-2-2><a id=__codelineno-2-2 name=__codelineno-2-2 href=#__codelineno-2-2></a>    <span class=o>...</span>
</span><span id=__span-2-3><a id=__codelineno-2-3 name=__codelineno-2-3 href=#__codelineno-2-3></a>    <span class=k>def</span><span class=w> </span><span class=nf>_adjust_process_count</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span><span id=__span-2-4><a id=__codelineno-2-4 name=__codelineno-2-4 href=#__codelineno-2-4></a>        <span class=o>...</span>
</span><span id=__span-2-5><a id=__codelineno-2-5 name=__codelineno-2-5 href=#__codelineno-2-5></a>        <span class=k>while</span> <span class=nb>len</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>_processes</span><span class=p>)</span> <span class=o>&lt;</span> <span class=bp>self</span><span class=o>.</span><span class=n>_max_workers</span><span class=p>:</span>  <span class=c1># 如果当前进程数小于最大进程数</span>
</span><span id=__span-2-6><a id=__codelineno-2-6 name=__codelineno-2-6 href=#__codelineno-2-6></a>            <span class=n>p</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>_context</span><span class=o>.</span><span class=n>Process</span><span class=p>(</span><span class=n>target</span><span class=o>=</span><span class=n>_process_worker</span><span class=p>,</span> <span class=n>args</span><span class=o>=</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>_call_queue</span><span class=p>,</span> <span class=n>result_queue</span><span class=p>))</span>  <span class=c1># 创建新的进程</span>
</span><span id=__span-2-7><a id=__codelineno-2-7 name=__codelineno-2-7 href=#__codelineno-2-7></a>            <span class=bp>self</span><span class=o>.</span><span class=n>_processes</span><span class=o>.</span><span class=n>add</span><span class=p>(</span><span class=n>p</span><span class=p>)</span>  <span class=c1># 将新进程加入进程集合</span>
</span><span id=__span-2-8><a id=__codelineno-2-8 name=__codelineno-2-8 href=#__codelineno-2-8></a>            <span class=n>p</span><span class=o>.</span><span class=n>start</span><span class=p>()</span>  <span class=c1># 启动新进程</span>
</span></code></pre></div> <p><code>_adjust_process_count</code>方法会根据当前待处理任务的数量和最大工作进程数来调整进程的数量。如果当前进程数小于最大进程数，则会创建新的进程并加入进程池中。</p> <p>通过上述机制，<code>ProcessPoolExecutor</code>能够利用多个进程实现真正的并行处理。每个进程都可以独立执行任务，不受全局解释锁的限制，因此多个任务可以在同一时间段内同时执行，实现真正的并行处理。</p> <p><strong>任务提交</strong>：</p> <div class="language-python highlight"><pre><span></span><code><span id=__span-3-1><a id=__codelineno-3-1 name=__codelineno-3-1 href=#__codelineno-3-1></a><span class=k>class</span><span class=w> </span><span class=nc>ProcessPoolExecutor</span><span class=p>(</span><span class=n>_base</span><span class=o>.</span><span class=n>Executor</span><span class=p>):</span>
</span><span id=__span-3-2><a id=__codelineno-3-2 name=__codelineno-3-2 href=#__codelineno-3-2></a>    <span class=o>...</span>
</span><span id=__span-3-3><a id=__codelineno-3-3 name=__codelineno-3-3 href=#__codelineno-3-3></a>    <span class=k>def</span><span class=w> </span><span class=nf>submit</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>fn</span><span class=p>,</span> <span class=o>*</span><span class=n>args</span><span class=p>,</span> <span class=o>**</span><span class=n>kwargs</span><span class=p>):</span>
</span><span id=__span-3-4><a id=__codelineno-3-4 name=__codelineno-3-4 href=#__codelineno-3-4></a>        <span class=o>...</span>
</span><span id=__span-3-5><a id=__codelineno-3-5 name=__codelineno-3-5 href=#__codelineno-3-5></a>        <span class=n>f</span> <span class=o>=</span> <span class=n>_base</span><span class=o>.</span><span class=n>Future</span><span class=p>()</span>
</span><span id=__span-3-6><a id=__codelineno-3-6 name=__codelineno-3-6 href=#__codelineno-3-6></a>        <span class=bp>self</span><span class=o>.</span><span class=n>_pending_work_items</span><span class=o>.</span><span class=n>put</span><span class=p>((</span><span class=n>f</span><span class=p>,</span> <span class=n>fn</span><span class=p>,</span> <span class=n>args</span><span class=p>,</span> <span class=n>kwargs</span><span class=p>))</span>  <span class=c1># 将任务放入待处理队列</span>
</span><span id=__span-3-7><a id=__codelineno-3-7 name=__codelineno-3-7 href=#__codelineno-3-7></a>        <span class=bp>self</span><span class=o>.</span><span class=n>_adjust_process_count</span><span class=p>()</span>  <span class=c1># 调整进程数量，确保有足够的进程来处理任务</span>
</span><span id=__span-3-8><a id=__codelineno-3-8 name=__codelineno-3-8 href=#__codelineno-3-8></a>        <span class=k>return</span> <span class=n>f</span>
</span></code></pre></div> <p>任务通过<code>submit</code>方法提交到进程池中，它将任务封装为一个元组，然后放入待处理队列<code>_pending_work_items</code>中。同时，<code>_adjust_process_count</code>方法会根据需要动态地调整进程数量，确保有足够的进程来处理任务。</p> <p><strong>进程调度和执行</strong>：</p> <div class="language-python highlight"><pre><span></span><code><span id=__span-4-1><a id=__codelineno-4-1 name=__codelineno-4-1 href=#__codelineno-4-1></a><span class=k>class</span><span class=w> </span><span class=nc>ProcessPoolExecutor</span><span class=p>(</span><span class=n>_base</span><span class=o>.</span><span class=n>Executor</span><span class=p>):</span>
</span><span id=__span-4-2><a id=__codelineno-4-2 name=__codelineno-4-2 href=#__codelineno-4-2></a>    <span class=o>...</span>
</span><span id=__span-4-3><a id=__codelineno-4-3 name=__codelineno-4-3 href=#__codelineno-4-3></a>    <span class=k>def</span><span class=w> </span><span class=nf>_adjust_process_count</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span><span id=__span-4-4><a id=__codelineno-4-4 name=__codelineno-4-4 href=#__codelineno-4-4></a>        <span class=o>...</span>
</span><span id=__span-4-5><a id=__codelineno-4-5 name=__codelineno-4-5 href=#__codelineno-4-5></a>        <span class=k>while</span> <span class=nb>len</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>_processes</span><span class=p>)</span> <span class=o>&lt;</span> <span class=bp>self</span><span class=o>.</span><span class=n>_max_workers</span><span class=p>:</span>  <span class=c1># 如果当前进程数小于最大进程数</span>
</span><span id=__span-4-6><a id=__codelineno-4-6 name=__codelineno-4-6 href=#__codelineno-4-6></a>            <span class=n>p</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>_context</span><span class=o>.</span><span class=n>Process</span><span class=p>(</span><span class=n>target</span><span class=o>=</span><span class=n>_process_worker</span><span class=p>,</span> <span class=n>args</span><span class=o>=</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>_call_queue</span><span class=p>,</span> <span class=n>result_queue</span><span class=p>))</span>  <span class=c1># 创建新的进程</span>
</span><span id=__span-4-7><a id=__codelineno-4-7 name=__codelineno-4-7 href=#__codelineno-4-7></a>            <span class=bp>self</span><span class=o>.</span><span class=n>_processes</span><span class=o>.</span><span class=n>add</span><span class=p>(</span><span class=n>p</span><span class=p>)</span>  <span class=c1># 将新进程加入进程集合</span>
</span><span id=__span-4-8><a id=__codelineno-4-8 name=__codelineno-4-8 href=#__codelineno-4-8></a>            <span class=n>p</span><span class=o>.</span><span class=n>start</span><span class=p>()</span>  <span class=c1># 启动新进程</span>
</span></code></pre></div> <p>在<code>_adjust_process_count</code>方法中，会根据当前待处理任务的数量和最大工作进程数来调整进程的数量。如果当前进程数小于最大进程数，则会创建新的进程并加入进程池中，并启动这些新的进程。</p> <p><strong>任务执行</strong>：</p> <div class="language-python highlight"><pre><span></span><code><span id=__span-5-1><a id=__codelineno-5-1 name=__codelineno-5-1 href=#__codelineno-5-1></a><span class=k>def</span><span class=w> </span><span class=nf>_process_worker</span><span class=p>(</span><span class=n>call_queue</span><span class=p>,</span> <span class=n>result_queue</span><span class=p>):</span>
</span><span id=__span-5-2><a id=__codelineno-5-2 name=__codelineno-5-2 href=#__codelineno-5-2></a>    <span class=k>while</span> <span class=kc>True</span><span class=p>:</span>
</span><span id=__span-5-3><a id=__codelineno-5-3 name=__codelineno-5-3 href=#__codelineno-5-3></a>        <span class=k>try</span><span class=p>:</span>
</span><span id=__span-5-4><a id=__codelineno-5-4 name=__codelineno-5-4 href=#__codelineno-5-4></a>            <span class=n>future</span><span class=p>,</span> <span class=n>fn</span><span class=p>,</span> <span class=n>args</span><span class=p>,</span> <span class=n>kwargs</span> <span class=o>=</span> <span class=n>call_queue</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=n>block</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>  <span class=c1># 从任务队列中获取任务</span>
</span><span id=__span-5-5><a id=__codelineno-5-5 name=__codelineno-5-5 href=#__codelineno-5-5></a>        <span class=k>except</span> <span class=n>queue</span><span class=o>.</span><span class=n>Empty</span><span class=p>:</span>  <span class=c1># 如果队列为空</span>
</span><span id=__span-5-6><a id=__codelineno-5-6 name=__codelineno-5-6 href=#__codelineno-5-6></a>            <span class=k>break</span>  <span class=c1># 退出循环</span>
</span><span id=__span-5-7><a id=__codelineno-5-7 name=__codelineno-5-7 href=#__codelineno-5-7></a>        <span class=k>try</span><span class=p>:</span>
</span><span id=__span-5-8><a id=__codelineno-5-8 name=__codelineno-5-8 href=#__codelineno-5-8></a>            <span class=n>result</span> <span class=o>=</span> <span class=n>fn</span><span class=p>(</span><span class=o>*</span><span class=n>args</span><span class=p>,</span> <span class=o>**</span><span class=n>kwargs</span><span class=p>)</span>  <span class=c1># 执行任务的可调用对象</span>
</span><span id=__span-5-9><a id=__codelineno-5-9 name=__codelineno-5-9 href=#__codelineno-5-9></a>        <span class=k>except</span> <span class=ne>BaseException</span> <span class=k>as</span> <span class=n>exc</span><span class=p>:</span>
</span><span id=__span-5-10><a id=__codelineno-5-10 name=__codelineno-5-10 href=#__codelineno-5-10></a>            <span class=n>result_queue</span><span class=o>.</span><span class=n>put</span><span class=p>((</span><span class=n>future</span><span class=p>,</span> <span class=n>exc</span><span class=p>))</span>  <span class=c1># 任务执行出现异常，将异常信息放入结果队列</span>
</span><span id=__span-5-11><a id=__codelineno-5-11 name=__codelineno-5-11 href=#__codelineno-5-11></a>        <span class=k>else</span><span class=p>:</span>
</span><span id=__span-5-12><a id=__codelineno-5-12 name=__codelineno-5-12 href=#__codelineno-5-12></a>            <span class=n>result_queue</span><span class=o>.</span><span class=n>put</span><span class=p>((</span><span class=n>future</span><span class=p>,</span> <span class=n>result</span><span class=p>))</span>  <span class=c1># 将任务的结果放入结果队列</span>
</span></code></pre></div> <p>在每个工作进程中，会循环地从任务队列<code>call_queue</code>中获取任务并执行。如果任务执行成功，则将任务的结果放入结果队列<code>result_queue</code>中；如果任务执行出现异常，则将异常信息放入结果队列。这样，多个工作进程可以并行地执行多个任务。</p> <p>让我们来分析一下为什么这样的循环能够实现并行处理：</p> <ol> <li><strong>多进程并行</strong>：虽然每个工作进程内部的循环是顺序执行的，但是由于存在多个工作进程，这些进程可以同时运行，并且各自独立地处理任务。每个工作进程都可以并行地从任务队列中获取任务并执行，而不会受到其他进程的影响。</li> <li><strong>任务调度</strong>：任务队列<code>call_queue</code>中存放着待执行的任务，多个工作进程可以从这个队列中并发地获取任务。当有任务可用时，多个工作进程可以同时竞争获取任务并执行，从而实现任务的并行处理。</li> <li><strong>结果收集</strong>：工作进程执行完任务后，会将执行结果放入结果队列<code>result_queue</code>中。主程序可以从结果队列中获取各个工作进程执行任务的结果，从而实现结果的收集。这种方式保证了在并行处理的同时，能够正确地收集和处理任务的结果。</li> </ol> <p><strong>结果获取</strong>：</p> <div class="language-python highlight"><pre><span></span><code><span id=__span-6-1><a id=__codelineno-6-1 name=__codelineno-6-1 href=#__codelineno-6-1></a><span class=k>class</span><span class=w> </span><span class=nc>_base</span><span class=o>.</span><span class=n>Future</span><span class=p>:</span>
</span><span id=__span-6-2><a id=__codelineno-6-2 name=__codelineno-6-2 href=#__codelineno-6-2></a>    <span class=o>...</span>
</span><span id=__span-6-3><a id=__codelineno-6-3 name=__codelineno-6-3 href=#__codelineno-6-3></a>    <span class=k>def</span><span class=w> </span><span class=nf>result</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>timeout</span><span class=o>=</span><span class=kc>None</span><span class=p>):</span>
</span><span id=__span-6-4><a id=__codelineno-6-4 name=__codelineno-6-4 href=#__codelineno-6-4></a>        <span class=o>...</span>
</span><span id=__span-6-5><a id=__codelineno-6-5 name=__codelineno-6-5 href=#__codelineno-6-5></a>        <span class=k>if</span> <span class=bp>self</span><span class=o>.</span><span class=n>_state</span> <span class=o>==</span> <span class=n>_FINISHED</span><span class=p>:</span>
</span><span id=__span-6-6><a id=__codelineno-6-6 name=__codelineno-6-6 href=#__codelineno-6-6></a>            <span class=k>return</span> <span class=bp>self</span><span class=o>.</span><span class=n>_result</span>  <span class=c1># 返回任务的执行结果</span>
</span><span id=__span-6-7><a id=__codelineno-6-7 name=__codelineno-6-7 href=#__codelineno-6-7></a>        <span class=o>...</span>
</span></code></pre></div> <p>通过<code>Future.result</code>方法可以获取任务的执行结果。如果任务已经执行完毕，则直接返回任务的执行结果；如果任务还未执行完毕，则根据需要等待一定时间直至任务执行完毕。</p> <h3 id=threadpoolexecutor>ThreadPoolExecutor<a class=headerlink href=#threadpoolexecutor title="Permanent link">&para;</a></h3> <p><strong>线程的创建和维护</strong>：</p> <div class="language-python highlight"><pre><span></span><code><span id=__span-7-1><a id=__codelineno-7-1 name=__codelineno-7-1 href=#__codelineno-7-1></a><span class=k>class</span><span class=w> </span><span class=nc>ThreadPoolExecutor</span><span class=p>(</span><span class=n>_base</span><span class=o>.</span><span class=n>Executor</span><span class=p>):</span>
</span><span id=__span-7-2><a id=__codelineno-7-2 name=__codelineno-7-2 href=#__codelineno-7-2></a>    <span class=k>def</span><span class=w> </span><span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>max_workers</span><span class=o>=</span><span class=kc>None</span><span class=p>,</span> <span class=n>thread_name_prefix</span><span class=o>=</span><span class=s1>&#39;&#39;</span><span class=p>):</span>
</span><span id=__span-7-3><a id=__codelineno-7-3 name=__codelineno-7-3 href=#__codelineno-7-3></a>        <span class=o>...</span>
</span><span id=__span-7-4><a id=__codelineno-7-4 name=__codelineno-7-4 href=#__codelineno-7-4></a>        <span class=k>if</span> <span class=n>max_workers</span> <span class=ow>is</span> <span class=kc>None</span><span class=p>:</span>
</span><span id=__span-7-5><a id=__codelineno-7-5 name=__codelineno-7-5 href=#__codelineno-7-5></a>            <span class=bp>self</span><span class=o>.</span><span class=n>_max_workers</span> <span class=o>=</span> <span class=nb>min</span><span class=p>(</span><span class=mi>32</span><span class=p>,</span> <span class=p>(</span><span class=n>os</span><span class=o>.</span><span class=n>cpu_count</span><span class=p>()</span> <span class=ow>or</span> <span class=mi>1</span><span class=p>)</span> <span class=o>+</span> <span class=mi>4</span><span class=p>)</span>
</span><span id=__span-7-6><a id=__codelineno-7-6 name=__codelineno-7-6 href=#__codelineno-7-6></a>        <span class=k>else</span><span class=p>:</span>
</span><span id=__span-7-7><a id=__codelineno-7-7 name=__codelineno-7-7 href=#__codelineno-7-7></a>            <span class=k>if</span> <span class=n>max_workers</span> <span class=o>&lt;=</span> <span class=mi>0</span><span class=p>:</span>
</span><span id=__span-7-8><a id=__codelineno-7-8 name=__codelineno-7-8 href=#__codelineno-7-8></a>                <span class=k>raise</span> <span class=ne>ValueError</span><span class=p>(</span><span class=s2>&quot;max_workers must be greater than 0&quot;</span><span class=p>)</span>
</span><span id=__span-7-9><a id=__codelineno-7-9 name=__codelineno-7-9 href=#__codelineno-7-9></a>            <span class=bp>self</span><span class=o>.</span><span class=n>_max_workers</span> <span class=o>=</span> <span class=n>max_workers</span>
</span><span id=__span-7-10><a id=__codelineno-7-10 name=__codelineno-7-10 href=#__codelineno-7-10></a>        <span class=o>...</span>
</span><span id=__span-7-11><a id=__codelineno-7-11 name=__codelineno-7-11 href=#__codelineno-7-11></a>        <span class=bp>self</span><span class=o>.</span><span class=n>_work_queue</span> <span class=o>=</span> <span class=n>queue</span><span class=o>.</span><span class=n>SimpleQueue</span><span class=p>()</span>  <span class=c1># 任务队列</span>
</span><span id=__span-7-12><a id=__codelineno-7-12 name=__codelineno-7-12 href=#__codelineno-7-12></a>        <span class=bp>self</span><span class=o>.</span><span class=n>_threads</span> <span class=o>=</span> <span class=nb>set</span><span class=p>()</span>  <span class=c1># 存放线程的集合</span>
</span><span id=__span-7-13><a id=__codelineno-7-13 name=__codelineno-7-13 href=#__codelineno-7-13></a>        <span class=bp>self</span><span class=o>.</span><span class=n>_thread_name_prefix</span> <span class=o>=</span> <span class=n>thread_name_prefix</span>
</span><span id=__span-7-14><a id=__codelineno-7-14 name=__codelineno-7-14 href=#__codelineno-7-14></a>        <span class=bp>self</span><span class=o>.</span><span class=n>_shutdown</span> <span class=o>=</span> <span class=kc>False</span>
</span></code></pre></div> <p>在初始化<code>ThreadPoolExecutor</code>时，它会创建一个任务队列<code>_work_queue</code>，用于存放提交到线程池的任务。同时，它还会维护一个线程集合<code>_threads</code>，用于存放线程池中的线程。<code>_max_workers</code>表示线程池中允许的最大线程数。</p> <p><strong>任务队列管理</strong>：</p> <div class="language-python highlight"><pre><span></span><code><span id=__span-8-1><a id=__codelineno-8-1 name=__codelineno-8-1 href=#__codelineno-8-1></a><span class=k>class</span><span class=w> </span><span class=nc>ThreadPoolExecutor</span><span class=p>(</span><span class=n>_base</span><span class=o>.</span><span class=n>Executor</span><span class=p>):</span>
</span><span id=__span-8-2><a id=__codelineno-8-2 name=__codelineno-8-2 href=#__codelineno-8-2></a>    <span class=o>...</span>
</span><span id=__span-8-3><a id=__codelineno-8-3 name=__codelineno-8-3 href=#__codelineno-8-3></a>    <span class=k>def</span><span class=w> </span><span class=nf>submit</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>fn</span><span class=p>,</span> <span class=o>*</span><span class=n>args</span><span class=p>,</span> <span class=o>**</span><span class=n>kwargs</span><span class=p>):</span>
</span><span id=__span-8-4><a id=__codelineno-8-4 name=__codelineno-8-4 href=#__codelineno-8-4></a>        <span class=o>...</span>
</span><span id=__span-8-5><a id=__codelineno-8-5 name=__codelineno-8-5 href=#__codelineno-8-5></a>        <span class=k>with</span> <span class=bp>self</span><span class=o>.</span><span class=n>_shutdown_lock</span><span class=p>:</span>
</span><span id=__span-8-6><a id=__codelineno-8-6 name=__codelineno-8-6 href=#__codelineno-8-6></a>            <span class=k>if</span> <span class=bp>self</span><span class=o>.</span><span class=n>_shutdown</span><span class=p>:</span>
</span><span id=__span-8-7><a id=__codelineno-8-7 name=__codelineno-8-7 href=#__codelineno-8-7></a>                <span class=k>raise</span> <span class=ne>RuntimeError</span><span class=p>(</span><span class=s1>&#39;cannot schedule new futures after shutdown&#39;</span><span class=p>)</span>
</span><span id=__span-8-8><a id=__codelineno-8-8 name=__codelineno-8-8 href=#__codelineno-8-8></a>            <span class=n>f</span> <span class=o>=</span> <span class=n>_base</span><span class=o>.</span><span class=n>Future</span><span class=p>()</span>
</span><span id=__span-8-9><a id=__codelineno-8-9 name=__codelineno-8-9 href=#__codelineno-8-9></a>            <span class=n>w</span> <span class=o>=</span> <span class=n>_WorkItem</span><span class=p>(</span><span class=n>f</span><span class=p>,</span> <span class=n>fn</span><span class=p>,</span> <span class=n>args</span><span class=p>,</span> <span class=n>kwargs</span><span class=p>)</span>  <span class=c1># 封装任务</span>
</span><span id=__span-8-10><a id=__codelineno-8-10 name=__codelineno-8-10 href=#__codelineno-8-10></a>            <span class=bp>self</span><span class=o>.</span><span class=n>_work_queue</span><span class=o>.</span><span class=n>put</span><span class=p>(</span><span class=n>w</span><span class=p>)</span>  <span class=c1># 将任务放入队列</span>
</span><span id=__span-8-11><a id=__codelineno-8-11 name=__codelineno-8-11 href=#__codelineno-8-11></a>            <span class=bp>self</span><span class=o>.</span><span class=n>_adjust_thread_count</span><span class=p>()</span>  <span class=c1># 调整线程数量</span>
</span><span id=__span-8-12><a id=__codelineno-8-12 name=__codelineno-8-12 href=#__codelineno-8-12></a>        <span class=k>return</span> <span class=n>f</span>
</span></code></pre></div> <p>在<code>submit</code>方法中，当有任务提交到线程池时，它会封装任务为<code>_WorkItem</code>对象，并将该对象放入任务队列<code>_work_queue</code>中。同时，它会调用<code>_adjust_thread_count</code>方法来调整线程数量，确保线程池中有足够的线程来执行任务。</p> <p><strong>线程池的状态管理</strong>：</p> <div class="language-python highlight"><pre><span></span><code><span id=__span-9-1><a id=__codelineno-9-1 name=__codelineno-9-1 href=#__codelineno-9-1></a><span class=k>class</span><span class=w> </span><span class=nc>ThreadPoolExecutor</span><span class=p>(</span><span class=n>_base</span><span class=o>.</span><span class=n>Executor</span><span class=p>):</span>
</span><span id=__span-9-2><a id=__codelineno-9-2 name=__codelineno-9-2 href=#__codelineno-9-2></a>    <span class=o>...</span>
</span><span id=__span-9-3><a id=__codelineno-9-3 name=__codelineno-9-3 href=#__codelineno-9-3></a>    <span class=k>def</span><span class=w> </span><span class=nf>_adjust_thread_count</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span><span id=__span-9-4><a id=__codelineno-9-4 name=__codelineno-9-4 href=#__codelineno-9-4></a>        <span class=c1># 调整线程数量</span>
</span><span id=__span-9-5><a id=__codelineno-9-5 name=__codelineno-9-5 href=#__codelineno-9-5></a>        <span class=k>if</span> <span class=nb>len</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>_threads</span><span class=p>)</span> <span class=o>&lt;</span> <span class=bp>self</span><span class=o>.</span><span class=n>_max_workers</span><span class=p>:</span>
</span><span id=__span-9-6><a id=__codelineno-9-6 name=__codelineno-9-6 href=#__codelineno-9-6></a>            <span class=n>t</span> <span class=o>=</span> <span class=n>threading</span><span class=o>.</span><span class=n>Thread</span><span class=p>(</span><span class=n>target</span><span class=o>=</span><span class=bp>self</span><span class=o>.</span><span class=n>_worker</span><span class=p>,</span> <span class=n>name</span><span class=o>=</span><span class=bp>self</span><span class=o>.</span><span class=n>_thread_name_prefix</span> <span class=o>+</span> <span class=nb>str</span><span class=p>(</span><span class=nb>len</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>_threads</span><span class=p>)))</span>
</span><span id=__span-9-7><a id=__codelineno-9-7 name=__codelineno-9-7 href=#__codelineno-9-7></a>            <span class=n>t</span><span class=o>.</span><span class=n>daemon</span> <span class=o>=</span> <span class=kc>True</span>
</span><span id=__span-9-8><a id=__codelineno-9-8 name=__codelineno-9-8 href=#__codelineno-9-8></a>            <span class=n>t</span><span class=o>.</span><span class=n>start</span><span class=p>()</span>
</span><span id=__span-9-9><a id=__codelineno-9-9 name=__codelineno-9-9 href=#__codelineno-9-9></a>            <span class=bp>self</span><span class=o>.</span><span class=n>_threads</span><span class=o>.</span><span class=n>add</span><span class=p>(</span><span class=n>t</span><span class=p>)</span>
</span></code></pre></div> <p><code>_adjust_thread_count</code>方法用于调整线程数量，当线程池中的线程数少于最大线程数时，会创建新的线程并添加到线程池中。</p> <p><strong>任务提交</strong>：</p> <div class="language-python highlight"><pre><span></span><code><span id=__span-10-1><a id=__codelineno-10-1 name=__codelineno-10-1 href=#__codelineno-10-1></a><span class=k>class</span><span class=w> </span><span class=nc>ThreadPoolExecutor</span><span class=p>(</span><span class=n>_base</span><span class=o>.</span><span class=n>Executor</span><span class=p>):</span>
</span><span id=__span-10-2><a id=__codelineno-10-2 name=__codelineno-10-2 href=#__codelineno-10-2></a>    <span class=o>...</span>
</span><span id=__span-10-3><a id=__codelineno-10-3 name=__codelineno-10-3 href=#__codelineno-10-3></a>    <span class=k>def</span><span class=w> </span><span class=nf>submit</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>fn</span><span class=p>,</span> <span class=o>*</span><span class=n>args</span><span class=p>,</span> <span class=o>**</span><span class=n>kwargs</span><span class=p>):</span>
</span><span id=__span-10-4><a id=__codelineno-10-4 name=__codelineno-10-4 href=#__codelineno-10-4></a>        <span class=o>...</span>
</span><span id=__span-10-5><a id=__codelineno-10-5 name=__codelineno-10-5 href=#__codelineno-10-5></a>        <span class=n>f</span> <span class=o>=</span> <span class=n>_base</span><span class=o>.</span><span class=n>Future</span><span class=p>()</span>
</span><span id=__span-10-6><a id=__codelineno-10-6 name=__codelineno-10-6 href=#__codelineno-10-6></a>        <span class=n>w</span> <span class=o>=</span> <span class=n>_WorkItem</span><span class=p>(</span><span class=n>f</span><span class=p>,</span> <span class=n>fn</span><span class=p>,</span> <span class=n>args</span><span class=p>,</span> <span class=n>kwargs</span><span class=p>)</span>  <span class=c1># 封装任务为_WorkItem对象</span>
</span><span id=__span-10-7><a id=__codelineno-10-7 name=__codelineno-10-7 href=#__codelineno-10-7></a>        <span class=bp>self</span><span class=o>.</span><span class=n>_work_queue</span><span class=o>.</span><span class=n>put</span><span class=p>(</span><span class=n>w</span><span class=p>)</span>  <span class=c1># 将任务放入任务队列</span>
</span><span id=__span-10-8><a id=__codelineno-10-8 name=__codelineno-10-8 href=#__codelineno-10-8></a>        <span class=bp>self</span><span class=o>.</span><span class=n>_adjust_thread_count</span><span class=p>()</span>  <span class=c1># 调整线程数量，确保有足够的线程来执行任务</span>
</span><span id=__span-10-9><a id=__codelineno-10-9 name=__codelineno-10-9 href=#__codelineno-10-9></a>        <span class=k>return</span> <span class=n>f</span>
</span></code></pre></div> <p>任务通过<code>submit</code>方法提交到线程池中，首先封装任务为<code>_WorkItem</code>对象，然后将该对象放入任务队列<code>_work_queue</code>中。在这个过程中，还会调用<code>_adjust_thread_count</code>方法来动态调整线程数量，确保有足够的线程来执行任务。</p> <p><strong>任务执行</strong>：</p> <div class="language-python highlight"><pre><span></span><code><span id=__span-11-1><a id=__codelineno-11-1 name=__codelineno-11-1 href=#__codelineno-11-1></a><span class=k>class</span><span class=w> </span><span class=nc>ThreadPoolExecutor</span><span class=p>(</span><span class=n>_base</span><span class=o>.</span><span class=n>Executor</span><span class=p>):</span>
</span><span id=__span-11-2><a id=__codelineno-11-2 name=__codelineno-11-2 href=#__codelineno-11-2></a>    <span class=o>...</span>
</span><span id=__span-11-3><a id=__codelineno-11-3 name=__codelineno-11-3 href=#__codelineno-11-3></a>    <span class=k>def</span><span class=w> </span><span class=nf>_worker</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span><span id=__span-11-4><a id=__codelineno-11-4 name=__codelineno-11-4 href=#__codelineno-11-4></a>        <span class=o>...</span>
</span><span id=__span-11-5><a id=__codelineno-11-5 name=__codelineno-11-5 href=#__codelineno-11-5></a>        <span class=k>try</span><span class=p>:</span>
</span><span id=__span-11-6><a id=__codelineno-11-6 name=__codelineno-11-6 href=#__codelineno-11-6></a>            <span class=k>while</span> <span class=kc>True</span><span class=p>:</span>
</span><span id=__span-11-7><a id=__codelineno-11-7 name=__codelineno-11-7 href=#__codelineno-11-7></a>                <span class=k>try</span><span class=p>:</span>
</span><span id=__span-11-8><a id=__codelineno-11-8 name=__codelineno-11-8 href=#__codelineno-11-8></a>                    <span class=n>work_item</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>_work_queue</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=n>block</span><span class=o>=</span><span class=kc>False</span><span class=p>)</span>  <span class=c1># 从任务队列中获取任务</span>
</span><span id=__span-11-9><a id=__codelineno-11-9 name=__codelineno-11-9 href=#__codelineno-11-9></a>                <span class=k>except</span> <span class=n>queue</span><span class=o>.</span><span class=n>Empty</span><span class=p>:</span>
</span><span id=__span-11-10><a id=__codelineno-11-10 name=__codelineno-11-10 href=#__codelineno-11-10></a>                    <span class=k>break</span>
</span><span id=__span-11-11><a id=__codelineno-11-11 name=__codelineno-11-11 href=#__codelineno-11-11></a>                <span class=o>...</span>
</span><span id=__span-11-12><a id=__codelineno-11-12 name=__codelineno-11-12 href=#__codelineno-11-12></a>        <span class=k>finally</span><span class=p>:</span>
</span><span id=__span-11-13><a id=__codelineno-11-13 name=__codelineno-11-13 href=#__codelineno-11-13></a>            <span class=bp>self</span><span class=o>.</span><span class=n>_threads</span><span class=o>.</span><span class=n>discard</span><span class=p>(</span><span class=n>threading</span><span class=o>.</span><span class=n>current_thread</span><span class=p>())</span>  <span class=c1># 从线程集合中移除当前线程</span>
</span></code></pre></div> <p>在**<code>_worker</code><strong>方法中，使用了一个</strong><code>while True</code>**的循环来保持线程的执行。在循环内部，线程会尝试从任务队列中获取任务执行，如果任务队列为空，则退出循环并结束线程的执行。这样，线程池中的线程可以不断地从任务队列中获取任务并执行，直到任务队列为空或者线程池被关闭。</p> <p>通过这个循环，线程池能够保持线程的持续执行，实现任务的并发处理。当任务队列为空时，线程会等待新的任务被提交到任务队列中，而不是无效地等待或者占用资源。这样可以有效地利用线程池中的线程资源，提高任务的执行效率。</p> <p><strong>任务完成</strong>：</p> <div class="language-python highlight"><pre><span></span><code><span id=__span-12-1><a id=__codelineno-12-1 name=__codelineno-12-1 href=#__codelineno-12-1></a><span class=k>class</span><span class=w> </span><span class=nc>_WorkItem</span><span class=p>:</span>
</span><span id=__span-12-2><a id=__codelineno-12-2 name=__codelineno-12-2 href=#__codelineno-12-2></a>    <span class=o>...</span>
</span><span id=__span-12-3><a id=__codelineno-12-3 name=__codelineno-12-3 href=#__codelineno-12-3></a>    <span class=k>def</span><span class=w> </span><span class=nf>run</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span><span id=__span-12-4><a id=__codelineno-12-4 name=__codelineno-12-4 href=#__codelineno-12-4></a>        <span class=o>...</span>
</span><span id=__span-12-5><a id=__codelineno-12-5 name=__codelineno-12-5 href=#__codelineno-12-5></a>        <span class=k>try</span><span class=p>:</span>
</span><span id=__span-12-6><a id=__codelineno-12-6 name=__codelineno-12-6 href=#__codelineno-12-6></a>            <span class=n>result</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>fn</span><span class=p>(</span><span class=o>*</span><span class=bp>self</span><span class=o>.</span><span class=n>args</span><span class=p>,</span> <span class=o>**</span><span class=bp>self</span><span class=o>.</span><span class=n>kwargs</span><span class=p>)</span>  <span class=c1># 执行任务的可调用对象</span>
</span><span id=__span-12-7><a id=__codelineno-12-7 name=__codelineno-12-7 href=#__codelineno-12-7></a>        <span class=k>except</span> <span class=ne>BaseException</span> <span class=k>as</span> <span class=n>exc</span><span class=p>:</span>
</span><span id=__span-12-8><a id=__codelineno-12-8 name=__codelineno-12-8 href=#__codelineno-12-8></a>            <span class=bp>self</span><span class=o>.</span><span class=n>future</span><span class=o>.</span><span class=n>set_exception</span><span class=p>(</span><span class=n>exc</span><span class=p>)</span>  <span class=c1># 任务执行出现异常，设置Future的异常状态</span>
</span><span id=__span-12-9><a id=__codelineno-12-9 name=__codelineno-12-9 href=#__codelineno-12-9></a>        <span class=k>else</span><span class=p>:</span>
</span><span id=__span-12-10><a id=__codelineno-12-10 name=__codelineno-12-10 href=#__codelineno-12-10></a>            <span class=bp>self</span><span class=o>.</span><span class=n>future</span><span class=o>.</span><span class=n>set_result</span><span class=p>(</span><span class=n>result</span><span class=p>)</span>  <span class=c1># 任务执行成功，设置Future的结果状态</span>
</span></code></pre></div> <p>任务在执行完毕后，会调用<code>run</code>方法来执行任务的可调用对象（函数）。如果任务执行成功，则通过<code>Future.set_result</code>方法设置任务的结果状态；如果任务执行出现异常，则通过<code>Future.set_exception</code>方法设置任务的异常状态。</p> <p><strong>结果获取</strong>：</p> <div class="language-python highlight"><pre><span></span><code><span id=__span-13-1><a id=__codelineno-13-1 name=__codelineno-13-1 href=#__codelineno-13-1></a><span class=k>class</span><span class=w> </span><span class=nc>_base</span><span class=o>.</span><span class=n>Future</span><span class=p>:</span>
</span><span id=__span-13-2><a id=__codelineno-13-2 name=__codelineno-13-2 href=#__codelineno-13-2></a>    <span class=o>...</span>
</span><span id=__span-13-3><a id=__codelineno-13-3 name=__codelineno-13-3 href=#__codelineno-13-3></a>    <span class=k>def</span><span class=w> </span><span class=nf>result</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>timeout</span><span class=o>=</span><span class=kc>None</span><span class=p>):</span>
</span><span id=__span-13-4><a id=__codelineno-13-4 name=__codelineno-13-4 href=#__codelineno-13-4></a>        <span class=o>...</span>
</span><span id=__span-13-5><a id=__codelineno-13-5 name=__codelineno-13-5 href=#__codelineno-13-5></a>        <span class=k>if</span> <span class=bp>self</span><span class=o>.</span><span class=n>_state</span> <span class=o>==</span> <span class=n>_FINISHED</span><span class=p>:</span>
</span><span id=__span-13-6><a id=__codelineno-13-6 name=__codelineno-13-6 href=#__codelineno-13-6></a>            <span class=k>return</span> <span class=bp>self</span><span class=o>.</span><span class=n>_result</span>  <span class=c1># 返回任务的执行结果</span>
</span><span id=__span-13-7><a id=__codelineno-13-7 name=__codelineno-13-7 href=#__codelineno-13-7></a>        <span class=o>...</span>
</span></code></pre></div> <p>通过<code>Future.result</code>方法可以获取任务的执行结果。如果任务已经执行完毕，则直接返回任务的执行结果；如果任务还未执行完毕，则根据需要等待一定时间直至任务执行完毕。</p> <p>以上是<code>ThreadPoolExecutor</code>执行过程的关键步骤，通过这些机制，线程池能够高效地管理线程资源，并执行提交到线程池的任务。</p> <h2 id=async-io>Async IO<a class=headerlink href=#async-io title="Permanent link">&para;</a></h2> <p><strong>事件循环（Event Loop）</strong>：</p> <ul> <li><code>asyncio</code> 基于事件循环模型，主要的控制流程是由事件循环来管理的。</li> <li>事件循环负责监控异步任务的状态，并在任务就绪时执行它们。</li> <li>事件循环会持续运行，直到所有的任务都完成。</li> </ul> <p><strong>协程（Coroutines）</strong>：</p> <ul> <li><code>asyncio</code> 使用协程来实现异步编程。</li> <li>协程是一种特殊的函数，可以在其中使用 <code>async</code> 关键字定义。</li> <li>在协程中可以使用 <code>await</code> 关键字来挂起执行，等待异步操作完成。</li> </ul> <p><strong>异步 I/O 操作</strong>：</p> <ul> <li><code>asyncio</code> 支持异步 I/O 操作，包括文件 I/O、网络 I/O、进程和线程池的调度等。</li> <li>使用异步 I/O 可以在等待 I/O 操作完成时挂起当前协程的执行，以充分利用系统资源。</li> </ul> <p><strong>任务和协程的调度</strong>：</p> <ul> <li><code>asyncio</code> 提供了 <code>asyncio.create_task()</code> 函数来创建协程任务（task），并将它们提交给事件循环进行调度。</li> <li>任务可以并发执行，并且可以相互等待、组合和取消。</li> </ul> <p><strong>并发编程</strong>：</p> <ul> <li><code>asyncio</code> 可以轻松处理大量的并发任务，而不需要创建大量的线程或进程。</li> <li>它在处理网络编程、高并发服务器、异步 I/O 操作等方面有着广泛的应用。</li> </ul> <p><strong>异常处理</strong>：</p> <ul> <li><code>asyncio</code> 提供了异常处理机制，可以捕获和处理异步操作中可能发生的异常。</li> <li>异常处理通常基于协程，可以很好地控制异常的传播。</li> </ul> <h3 id=event-loop>Event loop<a class=headerlink href=#event-loop title="Permanent link">&para;</a></h3> <p>当涉及到协程调度时，uvloop 主要依赖于 libuv 库提供的事件循环机制。libuv 是一个跨平台的异步 I/O 库，用于处理事件循环、套接字操作和其他底层操作。uvloop 使用 libuv 提供的事件循环来管理和调度协程。</p> <p><strong>事件循环初始化：</strong> uvloop 在启动时会初始化 libuv 的事件循环。这个过程通常在 uvloop 的 <code>_init_once()</code> 函数中完成。在初始化期间，uvloop 创建了一个 libuv 的事件循环对象，并将其设置为默认事件循环。</p> <div class="language-python highlight"><pre><span></span><code><span id=__span-14-1><a id=__codelineno-14-1 name=__codelineno-14-1 href=#__codelineno-14-1></a><span class=k>def</span><span class=w> </span><span class=nf>_init_once</span><span class=p>():</span>
</span><span id=__span-14-2><a id=__codelineno-14-2 name=__codelineno-14-2 href=#__codelineno-14-2></a>    <span class=n>uv_loop</span> <span class=o>=</span> <span class=n>ffi</span><span class=o>.</span><span class=n>new</span><span class=p>(</span><span class=s2>&quot;uv_loop_t*&quot;</span><span class=p>)</span>
</span><span id=__span-14-3><a id=__codelineno-14-3 name=__codelineno-14-3 href=#__codelineno-14-3></a>    <span class=n>uv</span><span class=o>.</span><span class=n>uv_loop_init</span><span class=p>(</span><span class=n>uv_loop</span><span class=p>)</span>
</span><span id=__span-14-4><a id=__codelineno-14-4 name=__codelineno-14-4 href=#__codelineno-14-4></a>    <span class=n>handle</span> <span class=o>=</span> <span class=n>ffi</span><span class=o>.</span><span class=n>new</span><span class=p>(</span><span class=s2>&quot;uv_handle_t*&quot;</span><span class=p>)</span>
</span><span id=__span-14-5><a id=__codelineno-14-5 name=__codelineno-14-5 href=#__codelineno-14-5></a>    <span class=n>uv</span><span class=o>.</span><span class=n>uv_unref</span><span class=p>(</span><span class=n>ffi</span><span class=o>.</span><span class=n>cast</span><span class=p>(</span><span class=s2>&quot;uv_handle_t*&quot;</span><span class=p>,</span> <span class=n>handle</span><span class=p>))</span>
</span><span id=__span-14-6><a id=__codelineno-14-6 name=__codelineno-14-6 href=#__codelineno-14-6></a>    <span class=n>handle</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span> <span class=o>=</span> <span class=n>uv_loop</span>
</span><span id=__span-14-7><a id=__codelineno-14-7 name=__codelineno-14-7 href=#__codelineno-14-7></a>    <span class=n>uv</span><span class=o>.</span><span class=n>uv_default_loop</span><span class=o>.</span><span class=n>argtypes</span> <span class=o>=</span> <span class=p>[</span><span class=n>ffi</span><span class=o>.</span><span class=n>TYPE_PTR</span><span class=p>]</span>
</span><span id=__span-14-8><a id=__codelineno-14-8 name=__codelineno-14-8 href=#__codelineno-14-8></a>    <span class=n>uv</span><span class=o>.</span><span class=n>uv_default_loop</span><span class=p>(</span><span class=n>handle</span><span class=p>)</span>
</span></code></pre></div> <p><strong>事件循环运行：</strong> 一旦事件循环初始化完成，uvloop 开始运行事件循环。这个过程通常在 <code>_run()</code> 函数中完成。在事件循环运行过程中，uvloop 会持续地监听事件，并根据事件类型执行相应的操作。</p> <div class="language-python highlight"><pre><span></span><code><span id=__span-15-1><a id=__codelineno-15-1 name=__codelineno-15-1 href=#__codelineno-15-1></a><span class=k>def</span><span class=w> </span><span class=nf>_run</span><span class=p>():</span>
</span><span id=__span-15-2><a id=__codelineno-15-2 name=__codelineno-15-2 href=#__codelineno-15-2></a>    <span class=k>while</span> <span class=kc>True</span><span class=p>:</span>
</span><span id=__span-15-3><a id=__codelineno-15-3 name=__codelineno-15-3 href=#__codelineno-15-3></a>        <span class=n>uv</span><span class=o>.</span><span class=n>uv_run</span><span class=p>(</span><span class=n>uv</span><span class=o>.</span><span class=n>uv_default_loop</span><span class=p>(),</span> <span class=n>UV_RUN_ONCE</span><span class=p>)</span>
</span><span id=__span-15-4><a id=__codelineno-15-4 name=__codelineno-15-4 href=#__codelineno-15-4></a>        <span class=n>_process_done_callbacks</span><span class=p>()</span>
</span><span id=__span-15-5><a id=__codelineno-15-5 name=__codelineno-15-5 href=#__codelineno-15-5></a>        <span class=n>_process_deferred_callbacks</span><span class=p>()</span>
</span></code></pre></div> <p><strong>协程状态管理：</strong> uvloop 跟踪每个协程的状态，并根据需要进行调度和处理。协程的状态可以是挂起（pending）、运行中（running）、已完成（finished）等。uvloop 使用 libuv 提供的事件循环机制来检查每个协程的状态，并根据需要执行相应的操作。</p> <div class="language-python highlight"><pre><span></span><code><span id=__span-16-1><a id=__codelineno-16-1 name=__codelineno-16-1 href=#__codelineno-16-1></a><span class=k>class</span><span class=w> </span><span class=nc>Future</span><span class=p>:</span>
</span><span id=__span-16-2><a id=__codelineno-16-2 name=__codelineno-16-2 href=#__codelineno-16-2></a>    <span class=k>def</span><span class=w> </span><span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>loop</span><span class=o>=</span><span class=kc>None</span><span class=p>):</span>
</span><span id=__span-16-3><a id=__codelineno-16-3 name=__codelineno-16-3 href=#__codelineno-16-3></a>        <span class=bp>self</span><span class=o>.</span><span class=n>_state</span> <span class=o>=</span> <span class=n>PENDING</span>
</span><span id=__span-16-4><a id=__codelineno-16-4 name=__codelineno-16-4 href=#__codelineno-16-4></a>        <span class=bp>self</span><span class=o>.</span><span class=n>_callbacks</span> <span class=o>=</span> <span class=p>[]</span>
</span><span id=__span-16-5><a id=__codelineno-16-5 name=__codelineno-16-5 href=#__codelineno-16-5></a>
</span><span id=__span-16-6><a id=__codelineno-16-6 name=__codelineno-16-6 href=#__codelineno-16-6></a>    <span class=k>def</span><span class=w> </span><span class=nf>set_result</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>result</span><span class=p>):</span>
</span><span id=__span-16-7><a id=__codelineno-16-7 name=__codelineno-16-7 href=#__codelineno-16-7></a>        <span class=bp>self</span><span class=o>.</span><span class=n>_result</span> <span class=o>=</span> <span class=n>result</span>
</span><span id=__span-16-8><a id=__codelineno-16-8 name=__codelineno-16-8 href=#__codelineno-16-8></a>        <span class=bp>self</span><span class=o>.</span><span class=n>_state</span> <span class=o>=</span> <span class=n>FINISHED</span>
</span><span id=__span-16-9><a id=__codelineno-16-9 name=__codelineno-16-9 href=#__codelineno-16-9></a>        <span class=bp>self</span><span class=o>.</span><span class=n>_call_callbacks</span><span class=p>()</span>
</span><span id=__span-16-10><a id=__codelineno-16-10 name=__codelineno-16-10 href=#__codelineno-16-10></a>
</span><span id=__span-16-11><a id=__codelineno-16-11 name=__codelineno-16-11 href=#__codelineno-16-11></a>    <span class=k>def</span><span class=w> </span><span class=nf>add_done_callback</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>fn</span><span class=p>):</span>
</span><span id=__span-16-12><a id=__codelineno-16-12 name=__codelineno-16-12 href=#__codelineno-16-12></a>        <span class=k>if</span> <span class=bp>self</span><span class=o>.</span><span class=n>_state</span> <span class=o>!=</span> <span class=n>PENDING</span><span class=p>:</span>
</span><span id=__span-16-13><a id=__codelineno-16-13 name=__codelineno-16-13 href=#__codelineno-16-13></a>            <span class=n>fn</span><span class=p>(</span><span class=bp>self</span><span class=p>)</span>
</span><span id=__span-16-14><a id=__codelineno-16-14 name=__codelineno-16-14 href=#__codelineno-16-14></a>        <span class=k>else</span><span class=p>:</span>
</span><span id=__span-16-15><a id=__codelineno-16-15 name=__codelineno-16-15 href=#__codelineno-16-15></a>            <span class=bp>self</span><span class=o>.</span><span class=n>_callbacks</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>fn</span><span class=p>)</span>
</span></code></pre></div> <p><strong>协程调度：</strong> uvloop 使用 libuv 库中的事件循环机制来调度协程。这包括通过注册事件处理器来等待特定的 I/O 事件，然后将控制权传递给相应的协程。</p> <div class="language-python highlight"><pre><span></span><code><span id=__span-17-1><a id=__codelineno-17-1 name=__codelineno-17-1 href=#__codelineno-17-1></a><span class=k>def</span><span class=w> </span><span class=nf>_run</span><span class=p>():</span>
</span><span id=__span-17-2><a id=__codelineno-17-2 name=__codelineno-17-2 href=#__codelineno-17-2></a>    <span class=k>while</span> <span class=kc>True</span><span class=p>:</span>
</span><span id=__span-17-3><a id=__codelineno-17-3 name=__codelineno-17-3 href=#__codelineno-17-3></a>        <span class=c1># 调用 libuv 的事件循环函数</span>
</span><span id=__span-17-4><a id=__codelineno-17-4 name=__codelineno-17-4 href=#__codelineno-17-4></a>        <span class=n>uv</span><span class=o>.</span><span class=n>uv_run</span><span class=p>(</span><span class=n>uv</span><span class=o>.</span><span class=n>uv_default_loop</span><span class=p>(),</span> <span class=n>UV_RUN_ONCE</span><span class=p>)</span>
</span><span id=__span-17-5><a id=__codelineno-17-5 name=__codelineno-17-5 href=#__codelineno-17-5></a>
</span><span id=__span-17-6><a id=__codelineno-17-6 name=__codelineno-17-6 href=#__codelineno-17-6></a>        <span class=c1># 处理已完成的协程任务</span>
</span><span id=__span-17-7><a id=__codelineno-17-7 name=__codelineno-17-7 href=#__codelineno-17-7></a>        <span class=n>_process_done_callbacks</span><span class=p>()</span>
</span><span id=__span-17-8><a id=__codelineno-17-8 name=__codelineno-17-8 href=#__codelineno-17-8></a>
</span><span id=__span-17-9><a id=__codelineno-17-9 name=__codelineno-17-9 href=#__codelineno-17-9></a>        <span class=c1># 处理延迟执行的回调任务</span>
</span><span id=__span-17-10><a id=__codelineno-17-10 name=__codelineno-17-10 href=#__codelineno-17-10></a>        <span class=n>_process_deferred_callbacks</span><span class=p>()</span>
</span></code></pre></div> <p><strong>事件处理：</strong> 在事件循环运行过程中，uvloop 会监听不同类型的事件，并执行相应的操作。例如，当某个套接字可读或可写时，uvloop 会调用相应的回调函数来处理这些事件。这些回调函数通常会触发对应协程的执行。</p> <div class="language-python highlight"><pre><span></span><code><span id=__span-18-1><a id=__codelineno-18-1 name=__codelineno-18-1 href=#__codelineno-18-1></a><span class=k>def</span><span class=w> </span><span class=nf>_on_readable</span><span class=p>(</span><span class=n>handle</span><span class=p>,</span> <span class=n>events</span><span class=p>,</span> <span class=n>error</span><span class=p>):</span>
</span><span id=__span-18-2><a id=__codelineno-18-2 name=__codelineno-18-2 href=#__codelineno-18-2></a>    <span class=c1># 处理套接字可读事件</span>
</span><span id=__span-18-3><a id=__codelineno-18-3 name=__codelineno-18-3 href=#__codelineno-18-3></a>    <span class=o>...</span>
</span><span id=__span-18-4><a id=__codelineno-18-4 name=__codelineno-18-4 href=#__codelineno-18-4></a>
</span><span id=__span-18-5><a id=__codelineno-18-5 name=__codelineno-18-5 href=#__codelineno-18-5></a><span class=k>def</span><span class=w> </span><span class=nf>_on_writable</span><span class=p>(</span><span class=n>handle</span><span class=p>,</span> <span class=n>events</span><span class=p>,</span> <span class=n>error</span><span class=p>):</span>
</span><span id=__span-18-6><a id=__codelineno-18-6 name=__codelineno-18-6 href=#__codelineno-18-6></a>    <span class=c1># 处理套接字可写事件</span>
</span><span id=__span-18-7><a id=__codelineno-18-7 name=__codelineno-18-7 href=#__codelineno-18-7></a>    <span class=o>...</span>
</span></code></pre></div> <p><strong>What is more crucial is understanding a bit beneath the surface about the mechanics of the event loop. Here are a few points worth stressing about the event loop:</strong></p> <blockquote> <p><strong><a class="magiclink magiclink-github magiclink-issue" href=https://github.com/squidfunk/mkdocs-material/issues/1 title="GitHub Issue: squidfunk/mkdocs-material #1">#1</a>: Coroutines don’t do much on their own until they are tied to the event loop.</strong></p> <p>You saw this point before in the explanation on generators, but it’s worth restating. If you have a main coroutine that awaits others, simply calling it in isolation has little effect:</p> <div class="language-python highlight"><pre><span></span><code><span id=__span-19-1><a id=__codelineno-19-1 name=__codelineno-19-1 href=#__codelineno-19-1></a><span class=kn>import</span><span class=w> </span><span class=nn>asyncio</span>
</span><span id=__span-19-2><a id=__codelineno-19-2 name=__codelineno-19-2 href=#__codelineno-19-2></a>
</span><span id=__span-19-3><a id=__codelineno-19-3 name=__codelineno-19-3 href=#__codelineno-19-3></a><span class=k>async</span> <span class=k>def</span><span class=w> </span><span class=nf>main</span><span class=p>():</span>
</span><span id=__span-19-4><a id=__codelineno-19-4 name=__codelineno-19-4 href=#__codelineno-19-4></a>    <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;Hello ...&quot;</span><span class=p>)</span>
</span><span id=__span-19-5><a id=__codelineno-19-5 name=__codelineno-19-5 href=#__codelineno-19-5></a>    <span class=k>await</span> <span class=n>asyncio</span><span class=o>.</span><span class=n>sleep</span><span class=p>(</span><span class=mi>1</span><span class=p>)</span>
</span><span id=__span-19-6><a id=__codelineno-19-6 name=__codelineno-19-6 href=#__codelineno-19-6></a>    <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;World!&quot;</span><span class=p>)</span>
</span><span id=__span-19-7><a id=__codelineno-19-7 name=__codelineno-19-7 href=#__codelineno-19-7></a>
</span><span id=__span-19-8><a id=__codelineno-19-8 name=__codelineno-19-8 href=#__codelineno-19-8></a><span class=n>routine</span> <span class=o>=</span> <span class=n>main</span><span class=p>()</span>
</span><span id=__span-19-9><a id=__codelineno-19-9 name=__codelineno-19-9 href=#__codelineno-19-9></a><span class=n>routine</span>
</span><span id=__span-19-10><a id=__codelineno-19-10 name=__codelineno-19-10 href=#__codelineno-19-10></a><span class=o>&lt;</span><span class=n>coroutine</span> <span class=nb>object</span> <span class=n>main</span> <span class=n>at</span> <span class=mh>0x1027a6150</span><span class=o>&gt;</span>
</span></code></pre></div> <p>Remember to use <code>asyncio.run()</code> to actually force execution by scheduling the <code>main()</code> coroutine (future object) for execution on the event loop:</p> <div class="language-python highlight"><pre><span></span><code><span id=__span-20-1><a id=__codelineno-20-1 name=__codelineno-20-1 href=#__codelineno-20-1></a><span class=n>asyncio</span><span class=o>.</span><span class=n>run</span><span class=p>(</span><span class=n>routine</span><span class=p>)</span>
</span><span id=__span-20-2><a id=__codelineno-20-2 name=__codelineno-20-2 href=#__codelineno-20-2></a><span class=n>Hello</span> <span class=o>...</span>
</span><span id=__span-20-3><a id=__codelineno-20-3 name=__codelineno-20-3 href=#__codelineno-20-3></a><span class=n>World</span><span class=err>!</span>
</span></code></pre></div> <p>(Other coroutines can be executed with <code>await</code>. It is typical to wrap just <code>main()</code> in <code>asyncio.run()</code>, and chained coroutines with <code>await</code> will be called from there.)</p> <p><strong><a class="magiclink magiclink-github magiclink-issue" href=https://github.com/squidfunk/mkdocs-material/issues/2 title="GitHub Issue: squidfunk/mkdocs-material #2">#2</a>: By default, an async IO event loop runs in a single thread and on a single CPU core.</strong></p> <p>Usually, running one single-threaded event loop in one CPU core is more than sufficient. It is also possible to run event loops across multiple cores. Check out this talk by John Reese for more, and be warned that your laptop may spontaneously combust.</p> <p><strong><a class="magiclink magiclink-github magiclink-issue" href=https://github.com/squidfunk/mkdocs-material/issues/3 title="GitHub Issue: squidfunk/mkdocs-material #3">#3</a>: Event loops are pluggable.</strong></p> <p>That is, you could, if you really wanted, write your own event loop implementation and have it run tasks just the same. This is wonderfully demonstrated in the uvloop package, which is an implementation of the event loop in Cython.</p> <p>That is what is meant by the term “pluggable event loop”: you can use any working implementation of an event loop, unrelated to the structure of the coroutines themselves. The asyncio package itself ships with two different event loop implementations, with the default being based on the selectors module. (The second implementation is built for Windows only.) </p> </blockquote> <p><strong>Example</strong></p> <p>当涉及到多个连接的情况时，我们可以创建多个客户端连接到服务器，并观察异步处理多个连接的过程。</p> <p>服务器端代码 <code>server.py</code>：</p> <div class="language-python highlight"><pre><span></span><code><span id=__span-21-1><a id=__codelineno-21-1 name=__codelineno-21-1 href=#__codelineno-21-1></a><span class=kn>import</span><span class=w> </span><span class=nn>asyncio</span>
</span><span id=__span-21-2><a id=__codelineno-21-2 name=__codelineno-21-2 href=#__codelineno-21-2></a>
</span><span id=__span-21-3><a id=__codelineno-21-3 name=__codelineno-21-3 href=#__codelineno-21-3></a><span class=k>async</span> <span class=k>def</span><span class=w> </span><span class=nf>handle_client</span><span class=p>(</span><span class=n>reader</span><span class=p>,</span> <span class=n>writer</span><span class=p>):</span>
</span><span id=__span-21-4><a id=__codelineno-21-4 name=__codelineno-21-4 href=#__codelineno-21-4></a>    <span class=k>while</span> <span class=kc>True</span><span class=p>:</span>
</span><span id=__span-21-5><a id=__codelineno-21-5 name=__codelineno-21-5 href=#__codelineno-21-5></a>        <span class=n>data</span> <span class=o>=</span> <span class=k>await</span> <span class=n>reader</span><span class=o>.</span><span class=n>read</span><span class=p>(</span><span class=mi>100</span><span class=p>)</span>
</span><span id=__span-21-6><a id=__codelineno-21-6 name=__codelineno-21-6 href=#__codelineno-21-6></a>        <span class=k>if</span> <span class=ow>not</span> <span class=n>data</span><span class=p>:</span>
</span><span id=__span-21-7><a id=__codelineno-21-7 name=__codelineno-21-7 href=#__codelineno-21-7></a>            <span class=k>break</span>
</span><span id=__span-21-8><a id=__codelineno-21-8 name=__codelineno-21-8 href=#__codelineno-21-8></a>        <span class=n>message</span> <span class=o>=</span> <span class=n>data</span><span class=o>.</span><span class=n>decode</span><span class=p>()</span>
</span><span id=__span-21-9><a id=__codelineno-21-9 name=__codelineno-21-9 href=#__codelineno-21-9></a>        <span class=n>addr</span> <span class=o>=</span> <span class=n>writer</span><span class=o>.</span><span class=n>get_extra_info</span><span class=p>(</span><span class=s1>&#39;peername&#39;</span><span class=p>)</span>
</span><span id=__span-21-10><a id=__codelineno-21-10 name=__codelineno-21-10 href=#__codelineno-21-10></a>        <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;Received </span><span class=si>{</span><span class=n>message</span><span class=si>}</span><span class=s2> from </span><span class=si>{</span><span class=n>addr</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>)</span>
</span><span id=__span-21-11><a id=__codelineno-21-11 name=__codelineno-21-11 href=#__codelineno-21-11></a>        <span class=n>writer</span><span class=o>.</span><span class=n>write</span><span class=p>(</span><span class=n>data</span><span class=p>)</span>
</span><span id=__span-21-12><a id=__codelineno-21-12 name=__codelineno-21-12 href=#__codelineno-21-12></a>        <span class=k>await</span> <span class=n>writer</span><span class=o>.</span><span class=n>drain</span><span class=p>()</span>
</span><span id=__span-21-13><a id=__codelineno-21-13 name=__codelineno-21-13 href=#__codelineno-21-13></a>    <span class=n>writer</span><span class=o>.</span><span class=n>close</span><span class=p>()</span>
</span><span id=__span-21-14><a id=__codelineno-21-14 name=__codelineno-21-14 href=#__codelineno-21-14></a>
</span><span id=__span-21-15><a id=__codelineno-21-15 name=__codelineno-21-15 href=#__codelineno-21-15></a><span class=k>async</span> <span class=k>def</span><span class=w> </span><span class=nf>main</span><span class=p>():</span>
</span><span id=__span-21-16><a id=__codelineno-21-16 name=__codelineno-21-16 href=#__codelineno-21-16></a>    <span class=n>server</span> <span class=o>=</span> <span class=k>await</span> <span class=n>asyncio</span><span class=o>.</span><span class=n>start_server</span><span class=p>(</span><span class=n>handle_client</span><span class=p>,</span> <span class=s1>&#39;127.0.0.1&#39;</span><span class=p>,</span> <span class=mi>8888</span><span class=p>)</span>
</span><span id=__span-21-17><a id=__codelineno-21-17 name=__codelineno-21-17 href=#__codelineno-21-17></a>    <span class=n>addr</span> <span class=o>=</span> <span class=n>server</span><span class=o>.</span><span class=n>sockets</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span><span class=o>.</span><span class=n>getsockname</span><span class=p>()</span>
</span><span id=__span-21-18><a id=__codelineno-21-18 name=__codelineno-21-18 href=#__codelineno-21-18></a>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s1>&#39;Serving on </span><span class=si>{</span><span class=n>addr</span><span class=si>}</span><span class=s1>&#39;</span><span class=p>)</span>
</span><span id=__span-21-19><a id=__codelineno-21-19 name=__codelineno-21-19 href=#__codelineno-21-19></a>    <span class=k>async</span> <span class=k>with</span> <span class=n>server</span><span class=p>:</span>
</span><span id=__span-21-20><a id=__codelineno-21-20 name=__codelineno-21-20 href=#__codelineno-21-20></a>        <span class=k>await</span> <span class=n>server</span><span class=o>.</span><span class=n>serve_forever</span><span class=p>()</span>
</span><span id=__span-21-21><a id=__codelineno-21-21 name=__codelineno-21-21 href=#__codelineno-21-21></a>
</span><span id=__span-21-22><a id=__codelineno-21-22 name=__codelineno-21-22 href=#__codelineno-21-22></a><span class=n>asyncio</span><span class=o>.</span><span class=n>run</span><span class=p>(</span><span class=n>main</span><span class=p>())</span>
</span></code></pre></div> <p>客户端代码 <code>client.py</code>：</p> <div class="language-python highlight"><pre><span></span><code><span id=__span-22-1><a id=__codelineno-22-1 name=__codelineno-22-1 href=#__codelineno-22-1></a><span class=kn>import</span><span class=w> </span><span class=nn>asyncio</span>
</span><span id=__span-22-2><a id=__codelineno-22-2 name=__codelineno-22-2 href=#__codelineno-22-2></a>
</span><span id=__span-22-3><a id=__codelineno-22-3 name=__codelineno-22-3 href=#__codelineno-22-3></a><span class=k>async</span> <span class=k>def</span><span class=w> </span><span class=nf>send_message</span><span class=p>(</span><span class=n>reader</span><span class=p>,</span> <span class=n>writer</span><span class=p>):</span>
</span><span id=__span-22-4><a id=__codelineno-22-4 name=__codelineno-22-4 href=#__codelineno-22-4></a>    <span class=n>writer</span><span class=o>.</span><span class=n>write</span><span class=p>(</span><span class=sa>b</span><span class=s2>&quot;Hello from client!</span><span class=se>\\</span><span class=s2>n&quot;</span><span class=p>)</span>
</span><span id=__span-22-5><a id=__codelineno-22-5 name=__codelineno-22-5 href=#__codelineno-22-5></a>    <span class=k>await</span> <span class=n>writer</span><span class=o>.</span><span class=n>drain</span><span class=p>()</span>
</span><span id=__span-22-6><a id=__codelineno-22-6 name=__codelineno-22-6 href=#__codelineno-22-6></a>    <span class=n>data</span> <span class=o>=</span> <span class=k>await</span> <span class=n>reader</span><span class=o>.</span><span class=n>read</span><span class=p>(</span><span class=mi>100</span><span class=p>)</span>
</span><span id=__span-22-7><a id=__codelineno-22-7 name=__codelineno-22-7 href=#__codelineno-22-7></a>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;Received: </span><span class=si>{</span><span class=n>data</span><span class=o>.</span><span class=n>decode</span><span class=p>()</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>)</span>
</span><span id=__span-22-8><a id=__codelineno-22-8 name=__codelineno-22-8 href=#__codelineno-22-8></a>
</span><span id=__span-22-9><a id=__codelineno-22-9 name=__codelineno-22-9 href=#__codelineno-22-9></a><span class=k>async</span> <span class=k>def</span><span class=w> </span><span class=nf>main</span><span class=p>():</span>
</span><span id=__span-22-10><a id=__codelineno-22-10 name=__codelineno-22-10 href=#__codelineno-22-10></a>    <span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=mi>5</span><span class=p>):</span>  <span class=c1># 创建5个客户端连接</span>
</span><span id=__span-22-11><a id=__codelineno-22-11 name=__codelineno-22-11 href=#__codelineno-22-11></a>        <span class=n>reader</span><span class=p>,</span> <span class=n>writer</span> <span class=o>=</span> <span class=k>await</span> <span class=n>asyncio</span><span class=o>.</span><span class=n>open_connection</span><span class=p>(</span><span class=s1>&#39;127.0.0.1&#39;</span><span class=p>,</span> <span class=mi>8888</span><span class=p>)</span>
</span><span id=__span-22-12><a id=__codelineno-22-12 name=__codelineno-22-12 href=#__codelineno-22-12></a>        <span class=k>await</span> <span class=n>send_message</span><span class=p>(</span><span class=n>reader</span><span class=p>,</span> <span class=n>writer</span><span class=p>)</span>
</span><span id=__span-22-13><a id=__codelineno-22-13 name=__codelineno-22-13 href=#__codelineno-22-13></a>        <span class=n>writer</span><span class=o>.</span><span class=n>close</span><span class=p>()</span>
</span><span id=__span-22-14><a id=__codelineno-22-14 name=__codelineno-22-14 href=#__codelineno-22-14></a>        <span class=k>await</span> <span class=n>writer</span><span class=o>.</span><span class=n>wait_closed</span><span class=p>()</span>
</span><span id=__span-22-15><a id=__codelineno-22-15 name=__codelineno-22-15 href=#__codelineno-22-15></a>
</span><span id=__span-22-16><a id=__codelineno-22-16 name=__codelineno-22-16 href=#__codelineno-22-16></a><span class=n>asyncio</span><span class=o>.</span><span class=n>run</span><span class=p>(</span><span class=n>main</span><span class=p>())</span>
</span></code></pre></div> <p>运行以上代码，我们会得到类似如下的输出：</p> <p>在服务器端 <code>server.py</code> 中的输出：</p> <div class="language-text highlight"><pre><span></span><code><span id=__span-23-1><a id=__codelineno-23-1 name=__codelineno-23-1 href=#__codelineno-23-1></a>Serving on (&#39;127.0.0.1&#39;, 8888)
</span><span id=__span-23-2><a id=__codelineno-23-2 name=__codelineno-23-2 href=#__codelineno-23-2></a>Received Hello from client! from (&#39;127.0.0.1&#39;, 54778)
</span><span id=__span-23-3><a id=__codelineno-23-3 name=__codelineno-23-3 href=#__codelineno-23-3></a>Received Hello from client! from (&#39;127.0.0.1&#39;, 54780)
</span><span id=__span-23-4><a id=__codelineno-23-4 name=__codelineno-23-4 href=#__codelineno-23-4></a>Received Hello from client! from (&#39;127.0.0.1&#39;, 54782)
</span><span id=__span-23-5><a id=__codelineno-23-5 name=__codelineno-23-5 href=#__codelineno-23-5></a>Received Hello from client! from (&#39;127.0.0.1&#39;, 54784)
</span><span id=__span-23-6><a id=__codelineno-23-6 name=__codelineno-23-6 href=#__codelineno-23-6></a>Received Hello from client! from (&#39;127.0.0.1&#39;, 54786)
</span></code></pre></div> <p>在客户端 <code>client.py</code> 中的输出：</p> <div class="language-text highlight"><pre><span></span><code><span id=__span-24-1><a id=__codelineno-24-1 name=__codelineno-24-1 href=#__codelineno-24-1></a>Received: Hello from client!
</span><span id=__span-24-2><a id=__codelineno-24-2 name=__codelineno-24-2 href=#__codelineno-24-2></a>Received: Hello from client!
</span><span id=__span-24-3><a id=__codelineno-24-3 name=__codelineno-24-3 href=#__codelineno-24-3></a>Received: Hello from client!
</span><span id=__span-24-4><a id=__codelineno-24-4 name=__codelineno-24-4 href=#__codelineno-24-4></a>Received: Hello from client!
</span><span id=__span-24-5><a id=__codelineno-24-5 name=__codelineno-24-5 href=#__codelineno-24-5></a>Received: Hello from client!
</span></code></pre></div> <p>从服务器端的输出可以看出，服务器成功接收了来自多个客户端的连接，并处理了它们发送的消息。由于使用了异步 I/O 操作，服务器可以同时处理多个连接而不会阻塞。客户端的输出显示了它们成功发送消息给服务器，并接收到了服务器的响应。</p> <h3 id=io>IO密集同步异步图解<a class=headerlink href=#io title="Permanent link">&para;</a></h3> <figure> <img alt="IO密集 同步" src=../../../../Python%E5%BC%82%E6%AD%A5/Untitled.png> <figcaption>IO密集 同步</figcaption> </figure> <figure> <img alt="IO密集 多进程" src=../../../../Python%E5%BC%82%E6%AD%A5/Untitled%201.png> <figcaption>IO密集 多进程</figcaption> </figure> <figure> <img alt="IO密集 多线程" src=../../../../Python%E5%BC%82%E6%AD%A5/Picture1.png> <figcaption>IO密集 多线程</figcaption> </figure> <figure> <img alt="IO密集 AsyncIO版本" src=../../../../Python%E5%BC%82%E6%AD%A5/Untitled%202.png> <figcaption>IO密集 AsyncIO版本</figcaption> </figure> <h2 id=summary>Summary<a class=headerlink href=#summary title="Permanent link">&para;</a></h2> <table> <thead> <tr> <th>特点</th> <th>线程并行</th> <th>进程并行</th> <th>Asyncio</th> </tr> </thead> <tbody> <tr> <td>执行模型</td> <td>多线程模型，每个线程执行一个任务</td> <td>多进程模型，每个进程执行一个任务</td> <td>单线程事件循环模型，通过异步执行任务</td> </tr> <tr> <td>并行性</td> <td>受到全局解释锁 (GIL) 限制，无法真正并行执行Python字节码</td> <td>每个进程有独立的解释器和内存空间，可以真正并行执行Python字节码</td> <td>单线程执行，通过事件循环实现任务的异步执行</td> </tr> <tr> <td>资源消耗</td> <td>较少的内存消耗，线程之间共享内存空间</td> <td>较大的内存消耗，进程之间独立的内存空间</td> <td>较少的内存消耗，单线程执行，无需创建额外的线程或进程</td> </tr> <tr> <td>阻塞操作</td> <td>阻塞操作会影响其他线程的执行</td> <td>阻塞操作不会影响其他进程的执行</td> <td>非阻塞操作，通过事件循环等待 I/O 事件的完成</td> </tr> <tr> <td>异常处理</td> <td>一个线程的异常可能会影响其他线程的执行</td> <td>一个进程的异常不会影响其他进程的执行</td> <td>异常处理通常基于协程，可以很好地控制异常的传播</td> </tr> <tr> <td>适用场景</td> <td>I/O密集型任务、网络编程等</td> <td>CPU密集型任务、I/O密集型任务、并发编程</td> <td>I/O密集型任务、高并发的网络编程等</td> </tr> </tbody> </table> <h2 id=reference>Reference<a class=headerlink href=#reference title="Permanent link">&para;</a></h2> <ol> <li><a href=https://realpython.com/async-io-python/#async-io-design-patterns>https://realpython.com/async-io-python/#async-io-design-patterns</a></li> <li><a href=https://realpython.com/python-concurrency/ >https://realpython.com/python-concurrency/</a></li> <li><a href=https://stackoverflow.com/questions/49005651/how-does-asyncio-actually-work/51116910#51116910>https://stackoverflow.com/questions/49005651/how-does-asyncio-actually-work/51116910#51116910</a></li> <li><a href=https://realpython.com/python-gil/ >https://realpython.com/python-gil/</a></li> </ol> </article> </div> <script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script> </div> <button type=button class="md-top md-icon" data-md-component=top hidden> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8z"/></svg> Back to top </button> </main> <footer class=md-footer> <div class="md-footer-meta md-typeset"> <div class="md-footer-meta__inner md-grid"> <div class=md-copyright> <div class=md-copyright__highlight> Copyright &copy; 2023 ~ now | Dewey Amer </div> Made with <a href=https://squidfunk.github.io/mkdocs-material/ target=_blank rel=noopener> Material for MkDocs </a> </div> </div> </div> </footer> </div> <div class=md-dialog data-md-component=dialog> <div class="md-dialog__inner md-typeset"></div> </div> <div class=md-progress data-md-component=progress role=progressbar></div> <script id=__config type=application/json>{"base": "../../../../..", "features": ["announce.dismiss", "content.action.edit", "content.action.view", "content.code.annotate", "content.code.copy", "content.tooltips", "navigation.expand", "navigation.indexes", "navigation.instant.prefetch", "navigation.instant.progress", "navigation.path", "navigation.sections", "navigation.tabs", "navigation.tabs.sticky", "navigation.top", "navigation.tracking", "search.highlight", "search.share", "search.suggest", "toc.follow"], "search": "../../../../../assets/javascripts/workers/search.973d3a69.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": null}</script> <script src=../../../../../assets/javascripts/bundle.f55a23d4.min.js></script> <script src=../../../../../javascripts/mathjax.js></script> <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script> <script src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script> </body> </html>